.. _rm-connect-to-sql-server:

=====================
Connect to SQL Server
=====================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. |db-type| replace:: SQL Server
.. |a-db| replace:: a SQL Server

.. include:: /includes/database-connections/connect-to-db-intro.rst

Steps
-----

.. _rm-prepare-db-sql-server:
.. _rm-prereq-mysql:

Prepare the Database
~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/database-connections/prepare-the-database-intro.rst

.. tabs::

   .. tab:: Snapshot Jobs
      :tabid: enable-snapshot-jobs

      .. procedure::
         :style: normal

         .. include:: /includes/fact-my-sql-setup-user-permission-step.rst

   .. tab:: Continuous Jobs
      :tabid: enable-continuous-jobs

      Running continuous jobs on Relational Migrator 
      requires the `binary log <https://dev.mysql.com/doc/refman/8.0/en/binary-log.html>`__ 
      to be enabled on your MySQL instance. The binary log (Binlog) 
      records all operations in the order they are committed to the 
      database. 

      .. procedure::
         :style: normal

         .. include:: /includes/fact-my-sql-setup-user-permission-step.rst

         .. step:: (Optional) Manually verify Binlog is enabled

               Relational Migrator automatically checks this setting for 
               you. To manually check the if the ``Binlog`` option is 
               enabled, use the queries below for your version of MySQL:

               .. note:: 

                  ``Binlog`` is automatically enabled by default 
                  on MySQL ``8.x`` versions.

               .. tabs::

                  .. tab:: MySql 8.x
                     :tabid: mysql-8x

                     .. code-block:: sql
                        :copyable: true

                        SELECT variable_value as "BINARY LOGGING STATUS (log-bin) ::"

                        FROM performance_schema.global_variables WHERE variable_name='log_bin'; 

                  .. tab:: MySql 5.x
                     :tabid: mysql-5x

                     .. code-block:: sql
                        :copyable: true

                        SELECT variable_value as "BINARY LOGGING STATUS (log-bin) ::"

                        FROM information_schema.global_variables WHERE variable_name='log_bin';

         .. step:: Locate and update the MySQL configuration file

            a. Run the following SQL query to get the ``server_id`` 
               value for your MySQL instance:

               .. tabs::

                  .. tab:: MySql 8.x
                     :tabid: mysql-8x

                     .. code-block:: sql
                        :copyable: true

                        SELECT variable_value 
                        FROM 
                        performance_schema.global_variables 
                        WHERE variable_name='server_id';

                  .. tab:: MySql 5.x
                     :tabid: mysql-5x

                     .. code-block:: sql
                        :copyable: true

                        SELECT variable_value 
                        FROM 
                        information_schema.global_variables 
                        WHERE variable_name='server_id';

            #. Locate the config file for your MySQL instance by running 
               the following ``mysqld`` command in your terminal:

               .. tabs::

                  .. tab:: Windows
                     :tabid: windows

                     .. code-block:: 
                        :copyable: true

                        mysql --help | findstr cnf

                  .. tab:: MacOS / Linux
                     :tabid: macos-linux

                     .. code-block:: 
                        :copyable: true

                        mysql --help | grep cnf

            #. Under the ``[mysqld]`` section of your MySQL 
               configuration file add the following lines. Replace 
               the ``XXXXX`` value with the ``server_id`` from the 
               previous query:

               .. tabs::

                  .. tab:: MySql 8.x
                     :tabid: mysql-8x

                     .. code-block::
                        :copyable: true

                        server-id = XXXXX
                        log_bin = mysql-bin
                        binlog_format = ROW
                        binlog_row_image = FULL
                        binlog_expire_logs_seconds = 864000

                  .. tab:: MySql 5.x
                     :tabid: mysql-5x

                     .. code-block:: 
                        :copyable: true

                        server-id = XXXXX
                        log_bin = mysql-bin
                        binlog_format = ROW
                        binlog_row_image = FULL
                        expire_log_days = 10 

               .. note::

                  If you're running MySQL on AWS RDS and `automated backups 
                  <https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithAutomatedBackups.html>`__
                  are not enabled, ``Binlog`` will be disabled, even if 
                  the values are set in the configuration file. 


.. _rm-sql-connection-string:

Database Connection String
~~~~~~~~~~~~~~~~~~~~~~~~~~

The general form for a SQL Server connection string is:

.. code-block::

   jdbc:sqlserver://[serverName[\instanceName][:portNumber]][;property=value[;property=value]]

For example, consider the following connection string:

.. code-block::

   jdbc:sqlserver://localhost:1433;databaseName=test

The preceding connection string specifies these connection details:

.. list-table::
   :header-rows: 1

   * - Property
     - Value
   * - Host
     - ``localhost``
   * - Port
     - ``1433``
   * - databaseName
     - ``test``

**Using Windows Integrated Authentication**

To enable Windows Integrated Authentication, add ``integratedSecurity=true;`` to the URI options.
Leave the :guilabel:`Username` and :guilabel:`Password` fields blank. Windows Integrated Authentication connects 
to the database using the credentials of the user who launched the Relational Migrator executable.

**Using TLS**

JDBC connections to SQL Server use Transport Layer Security (TLS) by default.
The encrypt property controls TLS. To disable it, set ``encrypt=false;``.
When TLS is enabled, the driver tries to validate the server's certificate by default.
To implicitly trust the server certificate, set ``trustServerCertificate=true;``.

.. note::

   To learn more about SQL Server connection strings, see:

   - `Setting Connection Properties <https://learn.microsoft.com/en-us/sql/connect/jdbc/setting-the-connection-properties>`__
   - `SQL Docs: Building the Connection URL <https://docs.microsoft.com/en-us/sql/connect/jdbc/building-the-connection-url?view=sql-server-ver15>`__.
   - `Connecting to SQL Server with the JDBC Driver <https://docs.microsoft.com/en-us/sql/connect/jdbc/connecting-to-sql-server-with-the-jdbc-driver?view=sql-server-ver15>`__

databaseName Property Behavior
''''''''''''''''''''''''''''''

In a SQL Server connection string, use the ``databaseName`` property to
specify the database to connect to. If you omit the ``databaseName``
property, the connection still succeeds but you can only see objects in
the default ``dbo`` schema in all databases.

If you specify the ``databaseName`` property, you can see tables from
all schemas within the specified database.


.. _rm-save-sql-server--connection:

Connect to |db-type|
~~~~~~~~~~~~~~~~~~~~
.. procedure::
   :style:  normal

   .. include:: /includes/database-connections/connect-to-db-steps-part-1.rst

   .. step:: To create a connection string by entering database information, enter the following:
      
      .. include:: /includes/table-sql-connection-fields.rst

   .. include:: /includes/database-connections/connect-to-db-steps-part-2.rst

Learn More
----------

- Relational Migrator relies on the open-source Debezium connector to 
  capture row-level changes. For more details, see
  `Debezium MySQL <https://debezium.io/documentation/reference/stable/connectors/mysql.html>`__.

.. include:: /includes/database-connections/connect-to-db-learn-more.rst